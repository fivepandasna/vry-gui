<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VRY — VALORANT Rank Yoinker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0b0f;
    --surface: #10121a;
    --surface2: #161923;
    --border: #1e2333;
    --border-bright: #2a3050;
    --accent: #ff4655;
    --text: #d4d8e8;
    --text-dim: #5a607a;
    --text-muted: #8890ab;
    --blue: #4c97ed;
    --red: #ee4d4d;
    --green: #12cc19;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    font-family: 'Barlow', sans-serif;
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    zoom: 1.18;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 999;
  }

  /* ── Header ── */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 28px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo { display: flex; align-items: center; gap: 10px; }
  .logo svg { width: 28px; height: 28px; }
  .logo-text { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 20px; letter-spacing: 0.12em; color: #fff; }
  .logo-text span { color: var(--accent); }

  .header-right { display: flex; align-items: center; gap: 16px; }

  .status-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text-dim);
    transition: background 0.3s, box-shadow 0.3s;
  }
  .status-dot.connected { background: var(--green); box-shadow: 0 0 7px var(--green); animation: pulse-dot 2s infinite; }
  .status-dot.error     { background: var(--accent); box-shadow: 0 0 7px var(--accent); }
  @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.45} }

  .state-badge {
    padding: 4px 11px;
    border-radius: 2px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 12px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border: 1px solid transparent;
  }
  .state-badge.ingame  { background:rgba(255,70,85,.12);  border-color:rgba(255,70,85,.4);  color:#ff8591; }
  .state-badge.pregame { background:rgba(103,237,76,.12); border-color:rgba(103,237,76,.4); color:#67ed4c; }
  .state-badge.menus   { background:rgba(238,241,54,.10); border-color:rgba(238,241,54,.35); color:#eef136; }
  .state-badge.waiting { background:rgba(90,96,122,.15);  border-color:rgba(90,96,122,.3);  color:var(--text-muted); }

  .map-info { font-family:'Rajdhani',sans-serif; font-weight:500; font-size:13px; color:var(--text-muted); letter-spacing:.06em; }

  /* ── Layout ── */
  .main { padding: 20px 28px; max-width: 1400px; margin: 0 auto; }

  .team-section { margin-bottom: 10px; }

  .team-label {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 10px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    padding: 5px 0;
    margin-bottom: 4px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .team-label::after { content:''; flex:1; height:1px; background:var(--border); }
  .team-label.blue { color: var(--blue); }
  .team-label.red  { color: var(--red); }

  .team-divider { height:1px; background:linear-gradient(90deg,transparent,var(--border-bright),transparent); margin:12px 0; }
  .players-grid { display:flex; flex-direction:column; gap:3px; }

  /* Grid: agent(52) | name(1fr) | current rank(185) | peak rank(185) | HS(90) | WinRate(80) | Level(70) */
  .col-headers,
  .player-card {
    display: grid;
    grid-template-columns: 52px minmax(130px,1fr) 185px 185px 90px 80px 70px;
    align-items: center;
  }

  /* ── Column headers ── */
  .col-headers { padding: 0 0 4px 0; }
  .col-header {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--text-dim);
    font-weight: 600;
    padding: 0 10px;
  }
  .col-header.center { text-align: center; }

  /* ── Player card ── */
  .player-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
    transition: border-color .2s, background .2s;
    animation: card-in .3s ease both;
    min-height: 54px;
  }
  .player-card:hover { border-color: var(--border-bright); background: var(--surface2); }
  @keyframes card-in { from{opacity:0;transform:translateX(-6px)} to{opacity:1;transform:none} }

  .player-card.self { border-left: 3px solid var(--accent); }
  .player-card.self::before {
    content:''; position:absolute; inset:0;
    background:linear-gradient(90deg,rgba(255,70,85,.06) 0%,transparent 55%);
    pointer-events:none;
  }

  /* Agent icon */
  .agent-cell { width:52px; height:54px; overflow:hidden; flex-shrink:0; }
  .agent-icon { width:100%; height:100%; object-fit:cover; object-position:top center; filter:brightness(.9); transition:filter .2s; }
  .player-card:hover .agent-icon { filter:brightness(1.05); }
  .agent-fallback { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:var(--surface2); font-family:'Rajdhani',sans-serif; font-weight:700; font-size:18px; color:var(--text-dim); }

  /* Name cell */
  .name-cell { padding:0 12px; min-width:0; }
  .player-name { font-family:'Rajdhani',sans-serif; font-weight:600; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:.03em; }
  .player-name.blue       { color: var(--blue); }
  .player-name.red        { color: var(--red); }
  .player-name.self-color { color: #dde041; }
  .agent-sub { font-size:11px; color:var(--text-dim); font-weight:400; letter-spacing:.05em; margin-top:1px; }
  .party-dot { display:inline-block; width:7px; height:7px; border-radius:50%; margin-right:4px; vertical-align:middle; }

  /* Rank cell — shared by current & peak */
  .rank-cell { padding:0 10px; display:flex; align-items:center; gap:9px; min-width:0; }

  .rank-icon-wrap { width:38px; height:38px; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
  .rank-icon { width:38px; height:38px; object-fit:contain; filter:drop-shadow(0 1px 4px rgba(0,0,0,.55)); }
  .rank-icon-placeholder { width:34px; height:34px; border-radius:50%; background:var(--border); border:1px solid var(--border-bright); }

  .rank-text { display:flex; flex-direction:column; gap:2px; min-width:0; overflow:hidden; }
  .rank-name-text { font-family:'Rajdhani',sans-serif; font-weight:700; font-size:13px; letter-spacing:.04em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .rank-sub { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text-muted); white-space:nowrap; }
  .rank-sub.dim { color:var(--text-dim); }

  /* rank name colours */
  .rc-unranked  { color: #5a607a; }
  .rc-iron      { color: #706d68; }
  .rc-bronze    { color: #bb8f5a; }
  .rc-silver    { color: #aeb2b2; }
  .rc-gold      { color: #c5ba3f; }
  .rc-platinum  { color: #18a7b9; }
  .rc-diamond   { color: #d864c7; }
  .rc-ascendant { color: #18a452; }
  .rc-immortal  { color: #dd4444; }
  .rc-radiant   { color: #fffdc8; text-shadow:0 0 8px rgba(255,253,200,.35); }

  /* HS */
  .hs-cell { padding:0 10px; display:flex; flex-direction:column; align-items:center; gap:2px; }
  .cell-label { font-size:9px; text-transform:uppercase; letter-spacing:.12em; color:var(--text-dim); font-weight:600; }
  .hs-value { font-family:'Share Tech Mono',monospace; font-size:15px; font-weight:600; }
  .hs-bar { width:50px; height:2px; background:var(--border); border-radius:1px; overflow:hidden; margin-top:2px; }
  .hs-bar-fill { height:100%; border-radius:1px; transition:width .6s ease; }

  /* Win Rate */
  .wr-cell { padding:0 10px; display:flex; flex-direction:column; align-items:center; gap:1px; }
  .wr-value { font-family:'Share Tech Mono',monospace; font-size:15px; font-weight:700; color:var(--text-muted); }

  /* Level */
  .level-cell { padding:0 10px; display:flex; align-items:center; justify-content:center; }
  .level-badge { font-family:'Share Tech Mono',monospace; font-size:12px; padding:2px 7px; border-radius:2px; border:1px solid; }
  .lv-1   { color:#d3d3d3; border-color:#333; }
  .lv-200 { color:#4747cc; border-color:#4747cc55; }
  .lv-300 { color:#cfcf4c; border-color:#cfcf4c55; }
  .lv-400 { color:#66d4d4; border-color:#66d4d455; }

  /* Empty state */
  .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:360px; gap:18px; animation:fade-in .5s ease; }
  @keyframes fade-in { from{opacity:0} to{opacity:1} }
  .empty-icon { width:56px; height:56px; opacity:.18; }
  .empty-title { font-family:'Rajdhani',sans-serif; font-weight:700; font-size:22px; letter-spacing:.1em; color:var(--text-dim); text-transform:uppercase; }
  .empty-sub { font-size:13px; color:var(--text-dim); text-align:center; font-family:'Share Tech Mono',monospace; line-height:1.7; }
  .ws-url { color:var(--accent); }
  .connecting { display:flex; gap:5px; align-items:center; margin-top:6px; justify-content:center; }
  .connecting span { width:4px; height:4px; border-radius:50%; background:var(--text-dim); animation:bounce 1.2s infinite ease-in-out both; }
  .connecting span:nth-child(2){animation-delay:.2s} .connecting span:nth-child(3){animation-delay:.4s}
  @keyframes bounce { 0%,80%,100%{transform:scale(.7);opacity:.4} 40%{transform:scale(1);opacity:1} }
</style>
</head>
<body>

<header class="header">
  <div class="logo">
    <svg viewBox="0 0 28 28" fill="none">
      <polygon points="14,2 26,26 2,26" fill="none" stroke="#ff4655" stroke-width="2"/>
      <line x1="14" y1="10" x2="14" y2="20" stroke="#ff4655" stroke-width="1.5"/>
      <circle cx="14" cy="22.5" r="1.4" fill="#ff4655"/>
    </svg>
    <div class="logo-text">VRY<span>.</span></div>
  </div>
  <div class="header-right">
    <div class="status-label">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">CONNECTING</span>
    </div>
    <div id="mapInfo" class="map-info" style="display:none"></div>
    <div id="stateBadge" class="state-badge waiting">WAITING</div>
  </div>
</header>

<main class="main">
  <div id="app"></div>
</main>

<script>
// ── Constants ─────────────────────────────────────────────────────────────────
const RANK_NAMES = [
  'Unranked','Unranked','Unranked',
  'Iron 1','Iron 2','Iron 3',
  'Bronze 1','Bronze 2','Bronze 3',
  'Silver 1','Silver 2','Silver 3',
  'Gold 1','Gold 2','Gold 3',
  'Platinum 1','Platinum 2','Platinum 3',
  'Diamond 1','Diamond 2','Diamond 3',
  'Ascendant 1','Ascendant 2','Ascendant 3',
  'Immortal 1','Immortal 2','Immortal 3',
  'Radiant'
];

const RANK_CSS = [
  'rc-unranked','rc-unranked','rc-unranked',
  'rc-iron','rc-iron','rc-iron',
  'rc-bronze','rc-bronze','rc-bronze',
  'rc-silver','rc-silver','rc-silver',
  'rc-gold','rc-gold','rc-gold',
  'rc-platinum','rc-platinum','rc-platinum',
  'rc-diamond','rc-diamond','rc-diamond',
  'rc-ascendant','rc-ascendant','rc-ascendant',
  'rc-immortal','rc-immortal','rc-immortal',
  'rc-radiant'
];

const PARTY_COLORS = ['#e34343','#d843e3','#4346e3','#43e3d0','#5ee343','#e2ed39','#d452cf','#aaaaaa'];

// tier index → icon URL (populated from valorant-api.com)
const RANK_ICONS = {};

async function loadRankIcons() {
  try {
    const res  = await fetch('https://valorant-api.com/v1/competitivetiers');
    const json = await res.json();
    // last entry = most recent episode's tier table
    const latest = json.data[json.data.length - 1];
    latest.tiers.forEach(t => {
      if (t.smallIcon) RANK_ICONS[t.tier] = t.smallIcon;
    });
  } catch (e) {
    console.warn('Could not load rank icons from valorant-api.com:', e);
  }
}

// ── Helpers ───────────────────────────────────────────────────────────────────
function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n|0)); }

function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function hsColor(hs) {
  const n = parseInt(hs);
  if (isNaN(n)) return '#5a607a';
  if (n >= 30) return '#12cc19';
  if (n >= 20) return '#c5ba3f';
  if (n >= 10) return '#bb8f5a';
  return '#dd4444';
}

function lvlClass(l) { return l>=400?'lv-400':l>=300?'lv-300':l>=200?'lv-200':'lv-1'; }

// ── Rank block (icon + name + sub-line) ───────────────────────────────────────
function rankBlock(rankIdx, subLine, subClass) {
  const idx  = clamp(rankIdx || 0, 0, 27);
  const name = RANK_NAMES[idx];
  const css  = RANK_CSS[idx];
  const url  = RANK_ICONS[idx];

  const iconHtml = url
    ? `<img class="rank-icon" src="${esc(url)}" alt="${esc(name)}" loading="lazy">`
    : `<div class="rank-icon-placeholder"></div>`;

  return `
    <div class="rank-cell">
      <div class="rank-icon-wrap">${iconHtml}</div>
      <div class="rank-text">
        <div class="rank-name-text ${css}">${esc(name)}</div>
        ${subLine ? `<div class="rank-sub ${subClass||''}">${esc(subLine)}</div>` : ''}
      </div>
    </div>`;
}

// ── Card ──────────────────────────────────────────────────────────────────────
function renderCard(p, idx) {
  const isSelf    = p.puuid === STATE.selfPuuid;
  const team      = p.team || 'Blue';
  const nameClass = isSelf ? 'self-color' : (team==='Blue' ? 'blue' : 'red');

  // Agent icon
  const agentImg  = STATE.agentImages[p.puuid] || p.agentImgLink;
  const agentName = p.agent || STATE.agentNames[p.puuid] || '?';
  const agentCell = agentImg
    ? `<img class="agent-icon" src="${esc(agentImg)}" alt="${esc(agentName)}"
          onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
       <div class="agent-fallback" style="display:none">${esc(agentName[0]||'?')}</div>`
    : `<div class="agent-fallback">${esc(agentName[0]||'?')}</div>`;

  const partyDot = p.partyNumber > 0
    ? `<span class="party-dot" style="background:${PARTY_COLORS[(p.partyNumber-1)%PARTY_COLORS.length]}"></span>`
    : '';

  // Current rank: show "XX RR" under rank name
  const currentRank = rankBlock(p.rank, p.rr !== undefined ? `${p.rr} RR` : '', '');

  // Peak rank: show act/ep tag under rank name
  const peakRank = rankBlock(p.peakRank, p.peakRankAct || '', 'dim');

  // HS
  const hsNum = parseInt(p.headshotPercentage);
  const hsClr = hsColor(p.headshotPercentage);
  const hsBar = isNaN(hsNum) ? 0 : Math.min(hsNum * 2, 100);

  // Win Rate
  const wr = p.winPercentage !== undefined ? p.winPercentage : 'N/A';

  return `
    <div class="player-card${isSelf?' self':''}" style="animation-delay:${idx*.04}s">
      <div class="agent-cell">${agentCell}</div>

      <div class="name-cell">
        <div class="player-name ${nameClass}">${partyDot}${esc(p.name||'Unknown')}</div>
        <div class="agent-sub">${esc(agentName)}</div>
      </div>

      ${currentRank}
      ${peakRank}

      <div class="hs-cell">
        <div class="cell-label">HS%</div>
        <div class="hs-value" style="color:${hsClr}">${isNaN(hsNum)?'N/A':hsNum+'%'}</div>
        <div class="hs-bar"><div class="hs-bar-fill" style="width:${hsBar}%;background:${hsClr}"></div></div>
      </div>

      <div class="wr-cell">
        <div class="cell-label">Win Rate</div>
        <div class="wr-value">${esc(String(wr))}</div>
      </div>

      <div class="level-cell">
        <div class="level-badge ${lvlClass(p.level)}">${esc(String(p.level||'?'))}</div>
      </div>
    </div>`;
}

function renderTeam(players, teamId) {
  if (!players.length) return '';
  const cls   = teamId==='Blue'?'blue':'red';
  const label = teamId==='Blue'?'Attack':'Defense';
  return `
    <div class="team-section">
      <div class="team-label ${cls}">${label}</div>
      <div class="players-grid">${players.map((p,i)=>renderCard(p,i)).join('')}</div>
    </div>`;
}

function renderHeaders() {
  return `
    <div class="col-headers">
      <div class="col-header"></div>
      <div class="col-header">Player</div>
      <div class="col-header">Current Rank</div>
      <div class="col-header">Peak Rank</div>
      <div class="col-header center">HS%</div>
      <div class="col-header center">Win Rate</div>
      <div class="col-header center">Level</div>
    </div>`;
}

// ── App state ─────────────────────────────────────────────────────────────────
const STATE = {
  gameState:   null,
  players:     {},
  selfPuuid:   null,
  map:         null,
  agentImages: {},
  agentNames:  {},
};

function render() {
  const app  = document.getElementById('app');
  const list = Object.values(STATE.players);

  if (!STATE.gameState || !list.length) {
    app.innerHTML = `
      <div class="empty-state">
        <svg class="empty-icon" viewBox="0 0 64 64" fill="none">
          <rect x="8" y="8" width="48" height="48" rx="4" stroke="#5a607a" stroke-width="2"/>
          <path d="M24 32h16M32 24v16" stroke="#5a607a" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <div class="empty-title">Awaiting Match</div>
        <div class="empty-sub">
          Connecting to vRY on <span class="ws-url">ws://localhost:1100</span><br>
          Make sure VALORANT and vRY are running.
          <div class="connecting"><span></span><span></span><span></span></div>
        </div>
      </div>`;
    return;
  }

  const blue  = list.filter(p => p.team==='Blue');
  const red   = list.filter(p => p.team==='Red');
  const other = list.filter(p => !p.team);

  let html = renderHeaders();

  if (blue.length && red.length) {
    html += renderTeam(blue, 'Blue');
    html += `<div class="team-divider"></div>`;
    html += renderTeam(red, 'Red');
  } else if (other.length) {
    html += `<div class="team-section">
      <div class="team-label blue">Your Party / Allies</div>
      <div class="players-grid">${other.map((p,i)=>renderCard(p,i)).join('')}</div>
    </div>`;
  } else {
    const all = [...blue,...red];
    html += `<div class="team-section">
      <div class="players-grid">${all.map((p,i)=>renderCard(p,i)).join('')}</div>
    </div>`;
  }

  app.innerHTML = html;
}

function updateHeader(gs) {
  const badge = document.getElementById('stateBadge');
  const map   = document.getElementById('mapInfo');
  const cls   = {INGAME:'ingame',PREGAME:'pregame',MENUS:'menus'};
  const lbl   = {INGAME:'IN-GAME',PREGAME:'AGENT SELECT',MENUS:'IN-MENUS'};
  badge.className   = `state-badge ${cls[gs]||'waiting'}`;
  badge.textContent = lbl[gs] || (gs||'WAITING');

  const m = Array.isArray(STATE.map) ? STATE.map[0] : STATE.map;
  if (m) { map.textContent=m; map.style.display=''; }
  else   { map.style.display='none'; }
}

function setConnected(ok) {
  document.getElementById('statusDot').className  = 'status-dot '+(ok?'connected':'error');
  document.getElementById('statusText').textContent = ok?'LIVE':'DISCONNECTED';
}

// ── WebSocket handlers ────────────────────────────────────────────────────────
function handleHeartbeat(data) {
  STATE.gameState = data.state;
  STATE.selfPuuid = data.puuid;
  STATE.map       = data.map;

  const next = {};
  Object.entries(data.players || {}).forEach(([puuid, p]) => {
    const prev = STATE.players[puuid] || {};
    next[puuid] = {
      ...prev, puuid,
      name:               p.name,
      team:               p.team,
      agent:              p.agent,
      rank:               p.rank,
      peakRank:           p.peakRank,
      peakRankAct:        p.peakRankAct,
      rr:                 p.rr,
      headshotPercentage: p.headshotPercentage,
      winPercentage:      p.winPercentage,
      level:              p.level,
      partyNumber:        p.partyNumber || 0,
      agentImgLink:       p.agentImgLink || prev.agentImgLink,
    };
  });
  STATE.players = next;
  updateHeader(STATE.gameState);
  render();
}

function handleMatchLoadout(data) {
  if (!data?.Players) return;
  Object.entries(data.Players).forEach(([puuid, pd]) => {
    if (!STATE.players[puuid]) STATE.players[puuid] = { puuid };
    if (pd.Agent) {
      STATE.agentImages[puuid] = pd.Agent;
      STATE.players[puuid].agentImgLink = pd.Agent;
    }
  });
  render();
}

// ── WebSocket connection ──────────────────────────────────────────────────────
let ws, reconnectTimer, reconnectDelay = 2000;

function connect() {
  try { ws = new WebSocket('ws://localhost:1100'); }
  catch(e) { schedule(); return; }

  ws.onopen  = () => { setConnected(true); reconnectDelay=2000; clearTimeout(reconnectTimer); };
  ws.onclose = () => { setConnected(false); schedule(); };
  ws.onerror = () => { setConnected(false); ws.close(); };
  ws.onmessage = evt => {
    try {
      const msg = JSON.parse(evt.data);
      if (msg.type==='heartbeat')    handleHeartbeat(msg);
      if (msg.type==='matchLoadout') handleMatchLoadout(msg);
    } catch(_) {}
  };
}

function schedule() {
  clearTimeout(reconnectTimer);
  reconnectTimer = setTimeout(() => {
    connect();
    reconnectDelay = Math.min(reconnectDelay*1.5, 15000);
  }, reconnectDelay);
}

// ── Boot ──────────────────────────────────────────────────────────────────────
(async () => {
  render();        // show empty/loading state immediately
  connect();       // start WS
  await loadRankIcons();  // fetch rank icons in background
  render();        // re-render once icons are ready
})();
</script>
</body>
</html>